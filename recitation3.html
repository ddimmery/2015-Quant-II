<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Drew Dimmery drewd@nyu.edu" />
  <meta name="dcterms.date" content="2015-02-13" />
  <title>Regression and Effective Samples</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="reveal.js/css/reveal.min.css"/>
    <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
    </style>
    <link rel="stylesheet" href="reveal.js/css/theme/simple.css" id="theme">
    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
      if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
      }
    </script>
    <!--[if lt IE 9]>
    <script src="reveal.js/lib/js/html5shiv.js"></script>
    <![endif]-->
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section>
    <h1 class="title">Regression and Effective Samples</h1>
    <h2 class="author">Drew Dimmery drewd@nyu.edu</h2>
    <h3 class="date">February 13, 2015</h3>
</section>

<section id="identification-estimation" class="slide level1">
<h1>Identification / Estimation</h1>
<ul>
<li>The “Four questions” may have been a little confusing.</li>
<li>Let me re-break down the last two questions as “Identification” and “Estimation”</li>
<li>“A regression is causal when the CEF it approximates is causal” - MHE</li>
<li>Identification consists (in this context) as the set of things you need to believe in order to believe the CEF is causal.</li>
<li>Thus, when we think about identification, we should think about assumptions.</li>
<li>Estimation is the process you use to estimate the CEF.</li>
</ul>
</section>
<section id="in-practice" class="slide level1">
<h1>In practice</h1>
<ul>
<li>The Conditional Independence Assumption would fall in identification.</li>
<li>I’d also throw in assumptions of additivity / linearity in this pot.</li>
<li>Estimation would include the populations/samples of interest, and all statistical inference.</li>
<li>But there’s a close connection between the two.</li>
<li>Problems in estimation can lead to changes in identifying assumptions.</li>
<li>So they aren’t completely separable.</li>
</ul>
</section>
<section id="covariate-adjustment-in-sampling" class="slide level1">
<h1>Covariate Adjustment in sampling</h1>
<ul>
<li>Lin, Winston. (2013) “Agnostic Notes on Regression Adjustments to Experimental Data: Reexamining Freedman’s Critique” <em>Annals of Applied Statistics</em>. 7(1):295-318.</li>
<li>Imagine that we are biologists. We are interested in leaf size.</li>
<li>Finding the size of leaves is hard, but weighing leaves is easy.</li>
<li>Key insight is that we can use auxilliary information to be smarter:
<ul>
<li>Sample from leaves on a tree.</li>
<li>Measure their size and weight.</li>
<li>Let <span class="math">\(\hat{y}_s\)</span> be the average size in the sample.</li>
<li>Let <span class="math">\(\hat{x}_s\)</span> be the average weight in the sample.</li>
<li>Population averages drop the subscript.</li>
<li>We know that <span class="math">\(\hat{y}_s\)</span> unbiased and consistent for <span class="math">\(\hat{y}\)</span></li>
<li>But we have extra information!</li>
<li>We also have <span class="math">\(\hat{x}\)</span> (all the weights)</li>
<li>This motivates the regression estimator:<br /><span class="math">\(\hat{\bar{y}}_{reg} = \hat{y}_s + \beta(\hat{x}-\hat{x}_s)\)</span></li>
<li>We get <span class="math">\(\beta\)</span> by a regression of leaf area on weight in the sample.</li>
</ul></li>
</ul>
</section>
<section id="connection-to-multiple-regression" class="slide level1">
<h1>Connection to Multiple Regression</h1>
<ul>
<li>In the case of OLS for the analysis of experiments, we have nearly the same setup.</li>
<li>Only difference is that we are sampling for both treatment and control.</li>
<li>This means that we must adjust both groups separately.</li>
<li>This motivates the use of covariate-treatment interactions.</li>
<li>Remember! Freedman (2008) showed that regression is <strong>biased</strong> and can be <strong>inconsistent</strong> for an experimental parameter in the case when interactions aren’t included.</li>
<li>This is something to consider in many different situations. There’s no reason to expect treatment and control groups to exhibit identical effects (even ones that are orthogonal to the causal parameter of interest)</li>
<li>This is just a particular sort of omitted variable bias, which you should already be familiar with.</li>
</ul>
</section>
<section id="covariate-adjustment-in-experiments" class="slide level1">
<h1>Covariate Adjustment in Experiments</h1>
<ul>
<li>Now imagine we are social scientists (hopefully this isn’t hard)</li>
<li>We are interested in the effects of a binary treatment on education, measured by a test.</li>
<li>Let’s set up a simulation.</li>
<li>250 students. Ten classes of 25 students each. Observed over two years.</li>
<li>First year has half good teachers and half bad.</li>
<li>We want to estimate the effect of the intervention in year 2.</li>
<li>Treatment is assigned randomly by <strong>individual</strong></li>
<li>Note: This setup usually demands an accounting of clustering, which I’m ignoring. Maybe I’ll bring it back later in the semester when we discuss SUTVA.</li>
</ul>
</section>
<section id="simulation" class="slide level1">
<h1>Simulation</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Variables which govern the size of the simulation (and our causal effects)</span>
nclass &lt;-<span class="st"> </span><span class="dv">5</span>
nstudent &lt;-<span class="st"> </span><span class="dv">25</span>
Eff &lt;-<span class="st"> </span><span class="dv">5</span>
EffSD &lt;-<span class="st"> </span><span class="dv">3</span>
<span class="co"># Simulate data</span>
<span class="kw">set.seed</span>(<span class="dv">1977</span>)
Yr1ClassType &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>),nclass*nstudent)
Yr2ClassType &lt;-<span class="st"> </span><span class="kw">sample</span>(Yr1ClassType,<span class="dt">replace=</span><span class="ot">FALSE</span>)
Yr1Score &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">2</span>*nclass*nstudent,<span class="dv">76</span>+Yr1ClassType*<span class="dv">5</span>,<span class="dv">9</span>)
<span class="co"># Fixed margins randomization</span>
Trt  &lt;-<span class="st"> </span><span class="kw">sample</span>(Yr1ClassType,<span class="dt">replace=</span><span class="ot">FALSE</span>)
<span class="co"># There is an independent effect of class type in each year</span>
<span class="co"># Variance is different across class types in year 2</span>
CtlOutcome &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">2</span>*nclass*nstudent,Yr1Score+Yr2ClassType*<span class="dv">3</span>,<span class="dv">9</span>-Yr2ClassType*<span class="dv">4</span>)
<span class="co"># Treatment effect is random, but with expectation Eff</span>
Yr2Obs &lt;-<span class="st"> </span>CtlOutcome +<span class="st"> </span>Trt *<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">2</span>*nclass*nstudent,Eff,EffSD)

<span class="kw">summary</span>(<span class="kw">lm</span>(Yr2Obs~Trt))$coefficients[<span class="dv">2</span>,]</code></pre>
<pre><code>##    Estimate  Std. Error     t value    Pr(&gt;|t|) 
## 4.307282238 1.558184168 2.764295984 0.006132827</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">lm</span>(Yr2Obs~Trt+Yr1Score))$coefficients[<span class="dv">2</span>,]</code></pre>
<pre><code>##     Estimate   Std. Error      t value     Pr(&gt;|t|) 
## 3.5206647114 1.0064194358 3.4982081884 0.0005553714</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We don&#39;t want the model-based SEs,</span>
<span class="co"># we want the robust standard errors:</span>
<span class="kw">try</span>(<span class="kw">library</span>(<span class="st">&#39;sandwich&#39;</span>),<span class="dt">silent=</span><span class="ot">TRUE</span>)
<span class="kw">try</span>(<span class="kw">library</span>(<span class="st">&#39;lmtest&#39;</span>),<span class="dt">silent=</span><span class="ot">TRUE</span>)
mod &lt;-<span class="st"> </span><span class="kw">lm</span>(Yr2Obs~Trt+Yr1Score)
<span class="kw">coeftest</span>(mod,<span class="kw">vcovHC</span>(mod,<span class="dt">type=</span><span class="st">&#39;HC2&#39;</span>))[<span class="st">&quot;Trt&quot;</span>,<span class="dv">2</span>]</code></pre>
<pre><code>## [1] 0.9997826</code></pre>
</section>
<section id="plot-data" class="slide level1">
<h1>Plot Data</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">jitter</span>(Trt),Yr2Obs,<span class="dt">axes=</span>F,<span class="dt">xlab=</span><span class="st">&quot;Treatment&quot;</span>,<span class="dt">ylab=</span><span class="st">&quot;Test Result (Yr 2)&quot;</span>,<span class="dt">col=</span><span class="st">&quot;grey&quot;</span>)
<span class="kw">axis</span>(<span class="dv">2</span>)
<span class="kw">axis</span>(<span class="dv">1</span>,<span class="dt">at=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))
<span class="co"># Calculate quantities for plotting CIs</span>
mns &lt;-<span class="st"> </span><span class="kw">tapply</span>(Yr2Obs,Trt,mean)
<span class="co"># SEs could also be pulled from the linear models we fit above with:</span>
ses &lt;-<span class="st"> </span><span class="kw">tapply</span>(Yr2Obs,Trt,function(x) <span class="kw">sd</span>(x)/<span class="kw">sqrt</span>(<span class="kw">length</span>(x)))
<span class="kw">points</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),mns,<span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">19</span>)
<span class="co"># Note the loop so that I only write this code once</span>
for(tr in <span class="kw">unique</span>(Trt)) {
  for(q in <span class="kw">c</span>(.<span class="dv">25</span>,.<span class="dv">025</span>)) {
    upr&lt;-mns[<span class="kw">as.character</span>(tr)]+<span class="kw">qnorm</span>(<span class="dv">1</span>-q)*ses[<span class="kw">as.character</span>(tr)]
    lwr &lt;-<span class="st"> </span>mns[<span class="kw">as.character</span>(tr)]-<span class="kw">qnorm</span>(<span class="dv">1</span>-q)*ses[<span class="kw">as.character</span>(tr)]
    <span class="kw">segments</span>(tr,upr,tr,lwr,<span class="dt">lwd=</span>(-<span class="dv">4</span>/<span class="kw">log</span>(q)))
  }
}</code></pre>
<figure>
<img src="figure/2-educ-plot-1.png" />
</figure>
</section>
<section id="partial-regression" class="slide level1">
<h1>Partial Regression</h1>
<ul>
<li>Can we make that plot a little more friendly?</li>
<li>Let’s residualize our outcome based on scores in the first period. This should remove a substantial amount of the variance in the outcome.</li>
<li>A few things to check, though.</li>
</ul>
<div class="fragment">
<pre class="sourceCode r"><code class="sourceCode r">OutcomeRes &lt;-<span class="st"> </span><span class="kw">residuals</span>(<span class="kw">lm</span>(Yr2Obs~Yr1Score<span class="dv">+0</span>))
TrtRes &lt;-<span class="st"> </span><span class="kw">residuals</span>(<span class="kw">lm</span>(Trt~Yr1Score<span class="dv">+0</span>))
<span class="kw">c</span>(<span class="kw">sd</span>(OutcomeRes),<span class="kw">sd</span>(Yr2Obs))</code></pre>
<pre><code>## [1]  8.131035 12.481726</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Diagnostics</span>
<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>))
<span class="kw">plot</span>(Yr1Score,Yr2Obs)
<span class="kw">plot</span>(Yr1Score,<span class="kw">jitter</span>(Trt))
<span class="kw">hist</span>(OutcomeRes)
<span class="kw">hist</span>(TrtRes)</code></pre>
<figure>
<img src="figure/2-resid-it-1.png" />
</figure>
</div>
</section>
<section id="residualized-plot" class="slide level1">
<h1>Residualized Plot</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">plot</span>(<span class="kw">jitter</span>(TrtRes),OutcomeRes,<span class="dt">axes=</span>F,<span class="dt">xlab=</span><span class="st">&quot;Treatment (residuals)&quot;</span>,<span class="dt">ylab=</span><span class="st">&quot;Test Result (residuals)&quot;</span>,<span class="dt">col=</span><span class="st">&quot;grey&quot;</span>)
<span class="kw">axis</span>(<span class="dv">2</span>)
<span class="kw">axis</span>(<span class="dv">1</span>)
<span class="co"># Pull information from the new bivariate model</span>
mns&lt;-<span class="kw">coef</span>(<span class="kw">lm</span>(OutcomeRes~TrtRes))
ses&lt;-<span class="kw">summary</span>(<span class="kw">lm</span>(OutcomeRes~TrtRes))$coefficients[,<span class="dv">2</span>]
TrtResMns&lt;-<span class="kw">tapply</span>(TrtRes,Trt,mean)
<span class="kw">names</span>(ses)&lt;-<span class="kw">names</span>(mns)&lt;-<span class="kw">names</span>(TrtResMns)
<span class="kw">points</span>(TrtResMns,mns,<span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">pch=</span><span class="dv">19</span>)
for(tr in <span class="kw">names</span>(TrtResMns)) {
  for(q in <span class="kw">c</span>(.<span class="dv">25</span>,.<span class="dv">025</span>)) {
    upr&lt;-mns[tr]+<span class="kw">qnorm</span>(<span class="dv">1</span>-q)*ses[tr]
    lwr &lt;-<span class="st"> </span>mns[tr]-<span class="kw">qnorm</span>(<span class="dv">1</span>-q)*ses[tr]
    <span class="kw">segments</span>(TrtResMns[tr],upr,TrtResMns[tr],lwr,<span class="dt">lwd=</span>(-<span class="dv">4</span>/<span class="kw">log</span>(q)))
  }
}</code></pre>
<figure>
<img src="figure/2-educ-resid-plot-1.png" />
</figure>
</section>
<section id="effective-samples" class="slide level1">
<h1>Effective Samples</h1>
<ul>
<li>We’re going to be investigating how to check the properties of your effective sample in regression.</li>
<li>The key result is:<br /><span class="math">\(\hat{\rho}_{reg}\,{\buildrel p \over \to}\,\frac{E[w_i \rho_i]}{E[w_i]} \text{ where } w_i = (D_i - E[D_i|X_i])^2\)</span></li>
<li>We estimate these weights with:<br /><span class="math">\(\hat{w}_i = \hat{D}_i^2\)</span> where <span class="math">\(D_i^2\)</span> is the <span class="math">\(i\)</span>th squared residual.</li>
<li>Because these estimates are “bad” for each unit, using them to reweight the sample is a bad idea.</li>
<li>Instead, we just use them to get a sense for what the effective sample is by examining the weight allocated to particular strata.</li>
<li>We will now explore how to do this.</li>
</ul>
</section>
<section id="example-paper" class="slide level1">
<h1>Example paper</h1>
<ul>
<li>We will be looking at Egan and Mullin (2012)</li>
<li>This paper explores the effect of local weather variations on belief in global warming.</li>
<li>Very cool paper! With an interesting randomized treatment.</li>
<li>But what is the effective sample?</li>
<li>In other words, where is weather (conditional on covariates) most variable?</li>
<li>That’s what we’ll explore.</li>
</ul>
</section>
<section id="load-in-data" class="slide level1">
<h1>Load in data</h1>
<ul>
<li>Get the data from Pat’s <a href="http://politics.as.nyu.edu/docs/IO/4819/egan_mullin_replication.zip">replication materials here</a>.</li>
</ul>
<div class="fragment">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(foreign)
d &lt;-<span class="st"> </span><span class="kw">read.dta</span>(<span class="st">&quot;gwdataset.dta&quot;</span>)</code></pre>
<pre><code>## Warning in read.dta(&quot;gwdataset.dta&quot;): value labels (&#39;q2&#39;) for &#39;jan07_q2&#39;
## are missing</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">zips &lt;-<span class="st"> </span><span class="kw">read.dta</span>(<span class="st">&quot;zipcodetostate.dta&quot;</span>)
zips&lt;-<span class="kw">unique</span>(zips[,<span class="kw">c</span>(<span class="st">&quot;statenum&quot;</span>,<span class="st">&quot;statefromzipfile&quot;</span>)])
pops &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;population_ests_2013.csv&quot;</span>)
pops$state &lt;-<span class="st"> </span><span class="kw">tolower</span>(pops$NAME)
d$getwarmord &lt;-<span class="st"> </span><span class="kw">as.double</span>(d$getwarmord)
<span class="co"># And estimate primary model of interest:</span>
out&lt;-<span class="kw">lm</span>(getwarmord~ddt_week+educ_hsless+educ_coll+educ_postgrad+educ_dk+party_rep+party_leanrep+party_leandem+party_dem+male+raceeth_black+raceeth_hisp+raceeth_notwbh+raceeth_dkref+age_1824+age_2534+age_3544+age_5564+age_65plus+age_dk+ideo_vcons+ideo_conservative+ideo_liberal+ideo_vlib+ideo_dk+attend_1+attend_2+attend_3+attend_5+attend_6+attend_9+<span class="kw">as.factor</span>(doi)+<span class="kw">as.factor</span>(statenum)+<span class="kw">as.factor</span>(wbnid_num),d)</code></pre>
</div>
</section>
<section id="base-model" class="slide level1">
<h1>Base Model</h1>
<ul>
<li>We won’t worry about standard errors yet.</li>
</ul>
<div class="fragment">
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(out)$coefficients[<span class="dv">1</span>:<span class="dv">10</span>,]</code></pre>
<pre><code>##                   Estimate  Std. Error    t value     Pr(&gt;|t|)
## (Intercept)    1.945740062 0.771478843  2.5220913 1.169077e-02
## ddt_week       0.004857915 0.002475887  1.9620908 4.979656e-02
## educ_hsless    0.057740175 0.024483855  2.3582959 1.838991e-02
## educ_coll      0.021456581 0.027094559  0.7919147 4.284407e-01
## educ_postgrad  0.049387053 0.030734047  1.6069167 1.081236e-01
## educ_dk        0.102935825 0.250495224  0.4109293 6.811386e-01
## party_rep     -0.243900010 0.036626759 -6.6590661 2.992461e-11
## party_leanrep -0.092808607 0.041811888 -2.2196703 2.647719e-02
## party_leandem  0.147408845 0.039023948  3.7773944 1.599612e-04
## party_dem      0.175426658 0.035266683  4.9742886 6.725131e-07</code></pre>
</div>
</section>
<section id="estimate-d2" class="slide level1">
<h1>Estimate D^2</h1>
<ul>
<li>We can simply square the residuals of a partial regression to get <span class="math">\(D^2\)</span>:</li>
</ul>
<div class="fragment">
<pre class="sourceCode r"><code class="sourceCode r">outD&lt;-<span class="kw">lm</span>(ddt_week~educ_hsless+educ_coll+educ_postgrad+educ_dk+party_rep+party_leanrep+party_leandem+party_dem+male+raceeth_black+raceeth_hisp+raceeth_notwbh+raceeth_dkref+age_1824+age_2534+age_3544+age_5564+age_65plus+age_dk+ideo_vcons+ideo_conservative+ideo_liberal+ideo_vlib+ideo_dk+attend_1+attend_2+attend_3+attend_5+attend_6+attend_9+<span class="kw">as.factor</span>(doi)+<span class="kw">as.factor</span>(statenum)+<span class="kw">as.factor</span>(wbnid_num),d)
D2 &lt;-<span class="st"> </span><span class="kw">residuals</span>(outD)^<span class="dv">2</span></code></pre>
</div>
</section>
<section id="effective-sample-statistics" class="slide level1">
<h1>Effective Sample Statistics</h1>
<ul>
<li>We can use these estimated weights for examining the sample.</li>
</ul>
<div class="fragment">
<pre class="sourceCode r"><code class="sourceCode r">compare_samples&lt;-<span class="st"> </span>d[,<span class="kw">c</span>(<span class="st">&quot;wave&quot;</span>,<span class="st">&quot;ddt_week&quot;</span>,<span class="st">&quot;ddt_twoweeks&quot;</span>,<span class="st">&quot;ddt_threeweeks&quot;</span>,<span class="st">&quot;party_rep&quot;</span>,<span class="st">&quot;attend_1&quot;</span>,<span class="st">&quot;ideo_conservative&quot;</span>,<span class="st">&quot;age_1824&quot;</span>,<span class="st">&quot;educ_hsless&quot;</span>)]
compare_samples &lt;-<span class="st"> </span><span class="kw">apply</span>(compare_samples,<span class="dv">2</span>,function(x) <span class="kw">c</span>(<span class="kw">mean</span>(x),<span class="kw">sd</span>(x),<span class="kw">weighted.mean</span>(x,D2),<span class="kw">sqrt</span>(<span class="kw">weighted.mean</span>((x-<span class="kw">weighted.mean</span>(x,D2))^<span class="dv">2</span>,D2))))
compare_samples &lt;-<span class="st"> </span><span class="kw">t</span>(compare_samples)
<span class="kw">colnames</span>(compare_samples) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Nominal Mean&quot;</span>,<span class="st">&quot;Nominal SD&quot;</span>,<span class="st">&quot;Effective Mean&quot;</span>, <span class="st">&quot;Effective SD&quot;</span>)
compare_samples</code></pre>
<pre><code>##                   Nominal Mean Nominal SD Effective Mean Effective SD
## wave                3.09693726  1.4252527     3.20788200    1.5609143
## ddt_week            3.83548593  5.9047249     5.11579140   10.8980228
## ddt_twoweeks        3.85505617  5.4572382     5.00137435    9.2262827
## ddt_threeweeks      3.96719696  4.7689594     5.10859485    8.4348180
## party_rep           0.29527208  0.4561989     0.28978321    0.4536617
## attend_1            0.11433244  0.3182383     0.12343459    0.3289354
## ideo_conservative   0.31132917  0.4630715     0.29325249    0.4552532
## age_1824            0.07195956  0.2584402     0.06881146    0.2531333
## educ_hsless         0.34151056  0.4742516     0.31219962    0.4633908</code></pre>
</div>
</section>
<section id="effective-sample-maps" class="slide level1">
<h1>Effective Sample Maps</h1>
<ul>
<li>But one of the most interesting things is to see this visually.</li>
<li>Where in the US does the effective sample emphasize?</li>
<li>To get at this, we’ll use some tools in R that make this incredibly easy.</li>
<li>In particular, we’ll do this in ggplot2.</li>
</ul>
<div class="fragment">
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Effective sample by state</span>
wt.by.state &lt;-<span class="st"> </span><span class="kw">tapply</span>(D2,d$statenum,sum)
wt.by.state &lt;-<span class="st"> </span>wt.by.state/<span class="kw">sum</span>(wt.by.state)*<span class="dv">100</span>
wt.by.state &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">D2=</span>wt.by.state,<span class="dt">statenum=</span><span class="kw">names</span>(wt.by.state))
data_for_map &lt;-<span class="st"> </span><span class="kw">merge</span>(wt.by.state,zips,<span class="dt">by=</span><span class="st">&quot;statenum&quot;</span>)
<span class="co"># Nominal Sample by state</span>
wt.by.state &lt;-<span class="st"> </span><span class="kw">tapply</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">6726</span>),d$statenum,sum)
wt.by.state &lt;-<span class="st"> </span>wt.by.state/<span class="kw">sum</span>(wt.by.state)*<span class="dv">100</span>
wt.by.state &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">Nom=</span>wt.by.state,<span class="dt">statenum=</span><span class="kw">names</span>(wt.by.state))
data_for_map &lt;-<span class="st"> </span><span class="kw">merge</span>(data_for_map,wt.by.state,<span class="dt">by=</span><span class="st">&quot;statenum&quot;</span>)
<span class="co"># Get correct state names</span>
<span class="kw">require</span>(maps,<span class="dt">quietly=</span><span class="ot">TRUE</span>)
<span class="kw">data</span>(state.fips)
data_for_map &lt;-<span class="st"> </span><span class="kw">merge</span>(state.fips,data_for_map,<span class="dt">by.x=</span><span class="st">&quot;abb&quot;</span>,<span class="dt">by.y=</span><span class="st">&quot;statefromzipfile&quot;</span>)
data_for_map$D2 &lt;-<span class="st"> </span><span class="kw">as.double</span>(<span class="kw">as.character</span>(data_for_map$D2))
data_for_map$Nom &lt;-<span class="st"> </span><span class="kw">as.double</span>(<span class="kw">as.character</span>(data_for_map$Nom))
data_for_map$state &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">as.character</span>(data_for_map$polyname),function(x)<span class="kw">strsplit</span>(x,<span class="st">&quot;:&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>])
data_for_map$Diff &lt;-<span class="st"> </span>data_for_map$D2 -<span class="st"> </span>data_for_map$Nom
data_for_map &lt;-<span class="st"> </span><span class="kw">merge</span>(data_for_map,pops,<span class="dt">by=</span><span class="st">&quot;state&quot;</span>)
data_for_map$PopPct &lt;-<span class="st"> </span>data_for_map$POPESTIMATE2013/<span class="kw">sum</span>(data_for_map$POPESTIMATE2013)*<span class="dv">100</span>
data_for_map$PopDiffEff &lt;-<span class="st"> </span>data_for_map$D2 -<span class="st"> </span>data_for_map$PopPct
data_for_map$PopDiffNom &lt;-<span class="st"> </span>data_for_map$Nom -<span class="st"> </span>data_for_map$PopPct
data_for_map$PopDiff &lt;-<span class="st"> </span>data_for_map$PopDiffEff -<span class="st"> </span>data_for_map$PopDiffNom
<span class="kw">require</span>(ggplot2,<span class="dt">quietly=</span><span class="ot">TRUE</span>)
state_map &lt;-<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;state&quot;</span>)</code></pre>
</div>
</section>
<section id="more-setup" class="slide level1">
<h1>More setup</h1>
<pre class="sourceCode r"><code class="sourceCode r">plotEff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(data_for_map,<span class="kw">aes</span>(<span class="dt">map_id=</span>state))
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">geom_map</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>D2), <span class="dt">map =</span> state_map)
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">expand_limits</span>(<span class="dt">x =</span> state_map$long, <span class="dt">y =</span> state_map$lat) 
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">scale_fill_continuous</span>(<span class="st">&quot;% Weight&quot;</span>,<span class="dt">limits=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">16</span>),<span class="dt">low=</span><span class="st">&quot;white&quot;</span>, <span class="dt">high=</span><span class="st">&quot;black&quot;</span>)
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Effective Sample&quot;</span>)
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">theme</span>(
        <span class="dt">legend.position=</span><span class="kw">c</span>(.<span class="dv">2</span>,.<span class="dv">1</span>),<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,
        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text =</span> <span class="kw">element_blank</span>(), 
        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.background =</span> <span class="kw">element_blank</span>(), <span class="dt">plot.background =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.border =</span> <span class="kw">element_blank</span>(), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()
)

plotNom &lt;-<span class="st"> </span><span class="kw">ggplot</span>(data_for_map,<span class="kw">aes</span>(<span class="dt">map_id=</span>state))
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">geom_map</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>Nom), <span class="dt">map =</span> state_map)
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">expand_limits</span>(<span class="dt">x =</span> state_map$long, <span class="dt">y =</span> state_map$lat) 
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">scale_fill_continuous</span>(<span class="st">&quot;% Weight&quot;</span>,<span class="dt">limits=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">16</span>),<span class="dt">low=</span><span class="st">&quot;white&quot;</span>, <span class="dt">high=</span><span class="st">&quot;black&quot;</span>)
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Nominal Sample&quot;</span>)
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">theme</span>(
        <span class="dt">legend.position=</span><span class="kw">c</span>(.<span class="dv">2</span>,.<span class="dv">1</span>),<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,
        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text =</span> <span class="kw">element_blank</span>(), 
        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.background =</span> <span class="kw">element_blank</span>(), <span class="dt">plot.background =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.border =</span> <span class="kw">element_blank</span>(), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()
)</code></pre>
</section>
<section id="and-the-maps" class="slide level1">
<h1>And the maps</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(gridExtra,<span class="dt">quietly=</span><span class="ot">TRUE</span>)
<span class="kw">grid.arrange</span>(plotNom,plotEff,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre>
<figure>
<img src="figure/3-raw-maps-1.png" />
</figure>
</section>
<section id="setup-comparison-plot" class="slide level1">
<h1>Setup Comparison Plot</h1>
<pre class="sourceCode r"><code class="sourceCode r">plotDiff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(data_for_map,<span class="kw">aes</span>(<span class="dt">map_id=</span>state))
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">geom_map</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>Diff), <span class="dt">map =</span> state_map)
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">expand_limits</span>(<span class="dt">x =</span> state_map$long, <span class="dt">y =</span> state_map$lat) 
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">scale_fill_gradient2</span>(<span class="st">&quot;% Weight&quot;</span>,<span class="dt">low =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">mid =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;black&quot;</span>)
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Effective Weight Minus Nominal Weight&quot;</span>)
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">theme</span>(
        <span class="dt">legend.position=</span><span class="kw">c</span>(.<span class="dv">2</span>,.<span class="dv">1</span>),<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,
        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text =</span> <span class="kw">element_blank</span>(), 
        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.background =</span> <span class="kw">element_blank</span>(), <span class="dt">plot.background =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.border =</span> <span class="kw">element_blank</span>(), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()
)</code></pre>
</section>
<section id="difference-in-weights" class="slide level1">
<h1>Difference in Weights</h1>
<pre class="sourceCode r"><code class="sourceCode r">plotDiff</code></pre>
<figure>
<img src="figure/3-show-diff-1.png" />
</figure>
</section>
<section id="population-comparison" class="slide level1">
<h1>Population Comparison</h1>
<pre class="sourceCode r"><code class="sourceCode r">plotEff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(data_for_map,<span class="kw">aes</span>(<span class="dt">map_id=</span>state))
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">geom_map</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>PopDiffEff), <span class="dt">map =</span> state_map)
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">expand_limits</span>(<span class="dt">x =</span> state_map$long, <span class="dt">y =</span> state_map$lat) 
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">scale_fill_gradient2</span>(<span class="st">&quot;% Weight&quot;</span>,<span class="dt">limits=</span><span class="kw">c</span>(-<span class="dv">2</span>,<span class="dv">6</span>),<span class="dt">low=</span><span class="st">&quot;red&quot;</span>,<span class="dt">mid=</span><span class="st">&quot;white&quot;</span>,<span class="dt">high=</span><span class="st">&quot;black&quot;</span>)
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Effective Sample&quot;</span>)
plotEff &lt;-<span class="st"> </span>plotEff +<span class="st"> </span><span class="kw">theme</span>(
        <span class="dt">legend.position=</span><span class="kw">c</span>(.<span class="dv">2</span>,.<span class="dv">1</span>),<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,
        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text =</span> <span class="kw">element_blank</span>(), 
        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.background =</span> <span class="kw">element_blank</span>(), <span class="dt">plot.background =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.border =</span> <span class="kw">element_blank</span>(), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()
)

plotNom &lt;-<span class="st"> </span><span class="kw">ggplot</span>(data_for_map,<span class="kw">aes</span>(<span class="dt">map_id=</span>state))
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">geom_map</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>PopDiffNom), <span class="dt">map =</span> state_map)
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">expand_limits</span>(<span class="dt">x =</span> state_map$long, <span class="dt">y =</span> state_map$lat) 
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">scale_fill_gradient2</span>(<span class="st">&quot;% Weight&quot;</span>,<span class="dt">limits=</span><span class="kw">c</span>(-<span class="dv">2</span>,<span class="dv">6</span>),<span class="dt">low =</span> <span class="st">&quot;red&quot;</span>,<span class="dt">mid=</span><span class="st">&quot;white&quot;</span>,<span class="dt">high=</span><span class="st">&quot;black&quot;</span>)
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Nominal Sample&quot;</span>)
plotNom &lt;-<span class="st"> </span>plotNom +<span class="st"> </span><span class="kw">theme</span>(
        <span class="dt">legend.position=</span><span class="kw">c</span>(.<span class="dv">2</span>,.<span class="dv">1</span>),<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,
        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text =</span> <span class="kw">element_blank</span>(), 
        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.background =</span> <span class="kw">element_blank</span>(), <span class="dt">plot.background =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.border =</span> <span class="kw">element_blank</span>(), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()
)</code></pre>
</section>
<section id="population-comparison-plots" class="slide level1">
<h1>Population Comparison Plots</h1>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grid.arrange</span>(plotNom,plotEff,<span class="dt">ncol=</span><span class="dv">2</span>)</code></pre>
<figure>
<img src="figure/3-show-pop-comps-1.png" />
</figure>
</section>
<section id="setup-new-comparison-plot" class="slide level1">
<h1>Setup New Comparison Plot</h1>
<pre class="sourceCode r"><code class="sourceCode r">plotDiff &lt;-<span class="st"> </span><span class="kw">ggplot</span>(data_for_map,<span class="kw">aes</span>(<span class="dt">map_id=</span>state))
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">geom_map</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>PopDiff), <span class="dt">map =</span> state_map)
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">expand_limits</span>(<span class="dt">x =</span> state_map$long, <span class="dt">y =</span> state_map$lat) 
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">scale_fill_gradient2</span>(<span class="st">&quot;% Weight&quot;</span>,<span class="dt">low =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">mid =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;black&quot;</span>)
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Effective Weight Minus Nominal Weight&quot;</span>)
plotDiff &lt;-<span class="st"> </span>plotDiff +<span class="st"> </span><span class="kw">theme</span>(
        <span class="dt">legend.position=</span><span class="kw">c</span>(.<span class="dv">2</span>,.<span class="dv">1</span>),<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,
        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text =</span> <span class="kw">element_blank</span>(), 
        <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.background =</span> <span class="kw">element_blank</span>(), <span class="dt">plot.background =</span> <span class="kw">element_blank</span>(),
        <span class="dt">panel.border =</span> <span class="kw">element_blank</span>(), <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>()
)</code></pre>
</section>
<section id="plot-difference" class="slide level1">
<h1>Plot Difference</h1>
<pre class="sourceCode r"><code class="sourceCode r">plotDiff</code></pre>
<figure>
<img src="figure/3-plot-pop-diff-1.png" />
</figure>
</section>
    </div>
  </div>


  <script src="reveal.js/lib/js/head.min.js"></script>
  <script src="reveal.js/js/reveal.min.js"></script>

  <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
//          { src: 'reveal.js/plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; }, }
//          { src: 'reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
]});
    </script>
    </body>
</html>
